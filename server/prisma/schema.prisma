// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String
  role      String   // "client" | "barber"
  avatarUrl String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  barberProfile BarberProfile?
  clientBookings Booking[] @relation("ClientBookings")
  favorites     Favorite[]
  reviews       Review[]
  clientNotes   BarberClientNote[]
  expenses      Expense[]
}

model Expense {
  id          String   @id @default(uuid())
  barberId    String
  barber      User     @relation(fields: [barberId], references: [id])
  amount      Float
  category    String   // "rent", "supplies", "utilities", "other"
  date        DateTime
  note        String?
  createdAt   DateTime @default(now())
}

model BarberProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id])
  
  specialties String   // JSON string: string[]
  rating      Float    @default(0)
  reviewCount Int      @default(0)
  location    String
  phone       String?
  bio         String
  schedule    String   // JSON string: { [key: string]: string[] }
  holidays    String?  // JSON string: string[]
  tier        String?  // "vip" | "standard"
  portfolio   String   // JSON string: string[]
  previewImageUrl String?
  
  // Subscription & Trial
  createdAt           DateTime @default(now())
  subscriptionStatus  String   @default("trial") // "trial", "active", "expired"
  subscriptionPlan    String?  @default("demo")  // "demo", "basic", "standard", "pro"
  subscriptionEndDate DateTime?

  // Verification
  verificationStatus      String   @default("none") // "none" | "pending" | "verified" | "rejected"
  verificationDocumentUrl String?

  // Relations
  services    Service[]
  bookings    Booking[]
  favoritedBy Favorite[]
  reviews     Review[]
  clientNotes BarberClientNote[]
}

model Service {
  id          String   @id @default(uuid())
  name        String
  duration    Int      // in minutes
  price       Float
  currency    String
  barberId    String
  barber      BarberProfile @relation(fields: [barberId], references: [id])
  bookings    Booking[]
}

model Booking {
  id        String   @id @default(uuid())
  date      String   // YYYY-MM-DD
  time      String   // HH:mm
  // Uniqueness for active bookings without partial indexes:
  // - Set to `${barberId}:${date}:${time}` on create
  // - Set to null when cancelled
  slotKey   String?  @unique
  status    String   // "pending" | "confirmed" | "cancelled" | "completed" | "no_show"
  comment   String?  // Reason for cancellation or other notes
  createdAt DateTime @default(now())

  clientId  String?
  client    User?    @relation("ClientBookings", fields: [clientId], references: [id])
  
  guestName  String?
  guestPhone String?

  barberId  String
  barber    BarberProfile @relation(fields: [barberId], references: [id])

  serviceId String
  service   Service @relation(fields: [serviceId], references: [id])

  @@index([barberId, date])
  @@index([clientId])
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  barberId  String
  barber    BarberProfile @relation(fields: [barberId], references: [id])

  @@unique([userId, barberId])
}

model BarberClientNote {
  id        String   @id @default(uuid())
  notes     String?  // The note text
  tags      String?  // JSON string: string[] e.g. ["VIP", "Late"]
  
  barberId  String
  barber    BarberProfile @relation(fields: [barberId], references: [id])
  
  clientId  String
  client    User     @relation(fields: [clientId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([barberId, clientId])
}

model Review {
  id        String   @id @default(uuid())
  rating    Int      // 1-5
  text      String?
  createdAt DateTime @default(now())

  userId    String
  user      User     @relation(fields: [userId], references: [id])

  barberId  String
  barber    BarberProfile @relation(fields: [barberId], references: [id])

  @@unique([userId, barberId])
}
